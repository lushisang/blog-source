title: 清理优先的程序设计
date: 2016-1-3
---

一、前因

每个程序除了实现功能外，在非功能方面，都有自己的侧重点。

比如火星探测器、医疗仪器控制程序等，对安全的要求肯定是非常高的。又比如导弹控制程序，对实时性要求很高。

而游戏开发，对性能要求很高，可以说是压榨每一份计算资源来实现最好的效果。

现在做的手机页游，可以利用的资源虽然比远古时代的游戏多多了，但相对当前的端游和电脑页游，还是少很多，因此优化是非常重要的。

[《手机页游的性能优化》]里写了几点优化方法，其中说到一个机制，就是本文讲的“清理优先”的机制。

因为现在的程序员们，不像远古时代的C语言程序员，很多没有性能优化和垃圾回收的意识，只专注于功能的实现。开发端游或电脑页游可能还可以勉强可用，但是手机页游资源实在太紧缺了。

而程序语言如JavaScript的垃圾回收机制，不管是引用计数还是标记清除，都只是工具，就像机床，提供了部分自动化功能，但还是需要程序员去操作，也就是该清理的还是得程序员告诉它。

所以就有了这个“清理优先”的程序设计，在语言垃圾回收机制的基础上，实现自动化或半自动化的垃圾标记和清理。避免垃圾未清理造成的游戏卡死、崩溃、bug等。

二、详解

这个设计，简单地说，就是如果要使用一切需要清理的功能或资源，都通过一个叫清理器的对象去获得，清理器内部会做记录，在需要清理时，直接调用清理器的清理方法即可。

当然，实际情况比较复杂，详解如下：

1. 理论上，清理器负责提供所有需要清理的功能，不需要清理的就不用包括。这些功能包括：
    1. 资源，包括图片、声音等。
    2. 事件侦听器，还有类似的Signal等。
    3. 缓动（Tween）、帧动画、骨骼动画等，这些库可能包含add、remove方法，add后会有全局引用，不可自动垃圾回收，需要调用remove才可解除。
    4. 定时任务。因为定时任务有对回调函数的全局引用。
    5. 。。。

（待完善）

三、结果

四、改进计划



[《手机页游的性能优化》]: http://blog.lushisang.com/mobile_web_game_performance_optimization/
